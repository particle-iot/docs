{
  "type": "libraries",
  "id": "SdCardLogHandlerRK",
  "links": {
    "download": "https://api.particle.io/v1/libraries/SdCardLogHandlerRK/archive/0.1.0.tar.gz"
  },
  "attributes": {
    "name": "SdCardLogHandlerRK",
    "version": "0.1.0",
    "installs": 17839,
    "license": "MIT",
    "author": "rickkas7@rickkas7.com",
    "sentence": "LogHandler for writing log messages to an micro SD card using the SdFat library",
    "url": "https://github.com/rickkas7/SdCardLogHandlerRK",
    "repository": "https://github.com/rickkas7/SdCardLogHandlerRK.git",
    "architectures": [
      "*"
    ],
    "visibility": "public",
    "mine": false
  },
  "kind": "community library",
  "letter": "s",
  "cardUrl": "/cards/libraries/s/SdCardLogHandlerRK",
  "versions": {
    "0.1.0": {
      "builds": {
        "2.0.1": {
          "photon": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          },
          "electron": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          },
          "argon": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          },
          "boron": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          }
        },
        "1.5.2": {
          "photon": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          },
          "electron": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          },
          "argon": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          },
          "boron": {
            "1-simple": true,
            "2-categories": true,
            "3-print": true
          }
        }
      }
    }
  },
  "readme": "# SdCardLogHandlerRK\n\n*Library for writing rotating logs to SD card on the Particle Photon and Electron*\n\nThe [full browsable API documentation is here](http://rickkas7.github.io/SdCardLogHandlerRK/).\n\nThe official location for this library is: [https://github.com/rickkas7/SdCardLogHandlerRK](https://github.com/rickkas7/SdCardLogHandlerRK).\n\nIt's in the Particle community libraries as: SdCardLogHandlerRK.\n\nIt's also possible (as of version 0.0.5) to use this to write an arbitrary stream of data, not hooked into the logging API. See SdCardPrintHandler, below.\n\n## Hardware\n\nYou'll need a SD card reader, presumably a Micro SD card reader. Make sure you get one that's compatible with the 3.3V logic levels used on the Photon and Electron. Some readers designed for the Arduino expect the 5V logic levels used by the original Arduino. I use [this one from Sparkfun](https://www.sparkfun.com/products/13743) but there are others. [This one from Adafruit](https://www.adafruit.com/product/254) works as well.\n\n![Photon](images/photon.jpg)\n\n![Electron](images/electron.jpg)\n\nThe SD card reader connects via the SPI interface. There are two SPI interfaces on the Photon and Electron and you can use either. Note that each SPI device must have a separate SS (sometimes called CS) pin. While it's listed in the table below as A2 (or D5), you can use any GPIO pin.\n\nPrimary SPI (SPI object)\n\n- A2 SS\n- A3 SCK\n- A4 MISO\n- A5 MOSI\n\nSecondary SPI (SPI1 object)\n\n- D5 SS\n- D4 SCK\n- D3 MISO\n- D2 MOSI\n\nIn the picture above:\n\n| Device | SPI Name | SD Reader | Color  |\n| ------ | -------- | --------- | ------ |\n| A2     | SS       | /CS       | Yellow |\n| A3     | SCK      | SCK       | Orange |\n| A4     | MISO     | DO        | Blue   |\n| A5     | MOSI     | DI        | Green  |\n| 3V3    |          | VCC       | Red    |\n| GND    |          | GND       | Black  |\n|        |          | CD        |        |\n\n\n### Adafruit AdaLogger FeatherWing\n\nYou can also use the [Adafruit AdaLogger FeatherWing](https://www.adafruit.com/product/2922). It contains an SD card reader and a RTC (real-time clock).\n\n![Adafruit Feather AdaLogger](images/feather-logger.jpg)\n\nIt connects to primary SPI (SPI object). The default connection is D5 for the SD card CS pin. It's possible to cut a trace and add a jumper wire to change the CS pin.\n\n- D5 CS\n- SCK\n- MISO\n- MOSI\n\n\n## Using the library\n\nThis library uses the [Logging API](https://docs.particle.io/reference/firmware/#logging) that was added in system firmware 0.6.0.\n\nFor example:\n\n```\nLog.trace(\"Low level debugging message\");\nLog.info(\"This is info message\");\nLog.warn(\"This is warning message\");\nLog.error(\"This is error message\");\n\nLog.info(\"System version: %s\", System.version().c_str());\n```\n\nIt does not remap Serial, so if you're using Serial.print for logging, you should switch to using Log.info instead.\n\nThe library creates a directory (default: \"logs\") at the top level of the SD card and stores the log files in that. Each log file is a .txt file 6-digit number beginning with 000001.txt. \n\nThe default log file is 1 MB (1000000 bytes), but you can reconfigure this. The actual size will be slightly larger than that, as the log is rotated when it exceeds the limit, and the file will always contain a whole log entry.\n\nWhen rotated, the default is to keep 10 log files, but this is configurable. The oldest is deleted when the maximum number is reached.\n\nBy default, SdCardLogHandler writes to Serial as well, like SerialLogHandler. This can be reconfigured.\n\nThis is the example program:\n\n```\n#include \"Particle.h\"\n\n#include \"SdFat.h\"\n#include \"SdCardLogHandlerRK.h\"\n\nSYSTEM_THREAD(ENABLED);\n\nconst int SD_CHIP_SELECT = A2;\nSdFat sd;\n\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED);\n\nsize_t counter = 0;\n\nvoid setup() {\n\tSerial.begin(9600);\n}\n\nvoid loop() {\n\tLog.info(\"testing counter=%d\", counter++);\n\tdelay(1000);\n}\n```\n\n### Initialize the SdFat library\n\nYou normally initialize the SdFat library by creating a global object for it. For example:\n\n```\nSdFat sd;\n```\n\nIf you are using SPI1 (the D pins) instead, use:\n\n```\nSdFat sd(1);\n```\n\nNote that you should not call `sd.begin()` in setup! The begin call is done by the SdCardLogHandler because it needs to be done earlier than setup, and also every time the card is ejected. \n\nIf you need to check for a successful call to begin in your code, instead using `logHandler.getLastBeginResult()`. You might do this before using the SD card in your code. If there is no SD card inserted, the result will be false.\n\n### Initialize the SdCardLogHandler\n\nNormally you initialize the SdCardLogHandler by creating a global object like this:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED);\n```\n\n- `sd` is the `SdFat` object, as described in the previous section\n- `SD_CHIP_SELECT` is the pin connected to the CS/SS pin. In the code above, `SD_CHIP_SELECT` is set to A2.\n- `SPI_FULL_SPEED` determines the speed to use, either full or `SPI_HALF_SPEED`.\n\nThere are also two optional parameters:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);\n```\n\nThe next optional parameter allows you to set the logging level.\n\n- `LOG_LEVEL_ALL` : special value that can be used to enable logging of all messages\n- `LOG_LEVEL_TRACE` : verbose output for debugging purposes\n- `LOG_LEVEL_INFO` : regular information messages\n- `LOG_LEVEL_WARN` : warnings and non-critical errors\n- `LOG_LEVEL_ERROR` : error messages\n- `LOG_LEVEL_NONE` : special value that can be used to disable logging of any messages\n\nAnd finally, you can use logging categories as well to set the level for certain categories:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_INFO, {\n\t{ \"app.network\", LOG_LEVEL_TRACE } \n});\n```\n\nThat example defaults to INFO but app.network events would be at TRACE level.\n\n### Using SdCardPrintHandler\n\nInstead of using SdCardLogHandler, you can use SdCardPrintHandler. This works like SdCardLogHandler, except it does not hook into the system log handler. This makes it useful for logging arbitrary data, and not have system logs mixed in.\n\n```\nSdCardPrintHandler printToCard(sd, SD_CHIP_SELECT, SPI_FULL_SPEED);\n```\n\nYou can use any of the print, println, or printf methods to print to the log file. The same circular log file structure is used, and the card is only written to after a \\n or println. A line is never broken up across multiple files.\n\n```\nprintToCard.println(\"testing!\");\n```\n\n### Options\n\nThe options below work with both SdCardLogHandler and SdCardPrintHandler.\n\nThere are also options available to control how logging is done. For example, if you want to change the default log file size to (approximately) 50000 bytes:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);\nSTARTUP(logHandler.withDesiredFileSize(50000));\n```\n\nYou can chain these together fluent-style to change multiple settings:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);\nSTARTUP(logHandler.withDesiredFileSize(50000).withMaxFilesToKeep(5));\n```\n\nBy default, SdCardLogHandler writes the log entries to Serial like SerialLogHandler. You can turn this off by using:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);\nSTARTUP(logHandler.withNoSerialLogging());\n```\n\nOr if you want to log to Serial1 (or another port) instead:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);\nSTARTUP(logHandler.withWriteToStream(&Serial1);\n```\n\nNormally, a sync operation is done after each log entry, which maximizes the chance the the log entry will be written out to SD card successfully. However, this will slow down operation if you do a lot of logging. You can have the SdFat library manage its own sync, which happens about every 512 bytes of log messages, by turning off sync after every entry:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);\nSTARTUP(logHandler.withSyncEveryEntry(false);\n```\n\nFinally, when the SD card is ejected, a check for being inserted is only done at most every 10 seconds. This is because there's a timeout operation that makes the operation slow, and doing it on every log entry would make the performance very bad. You can change this interval by using:\n\n```\nSdCardLogHandler logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED, LOG_LEVEL_TRACE);\nSTARTUP(logHandler.withCardCheckPeriod(30000);\n```\n\nThe value is in milliseconds; that changes the value from 10 seconds to 30 seconds.\n\n\n## Version History\n\n### 0.1.0\n\n- Breaking change: logHandler.loop() must be called from loop()\n\n- Breaking change: SdCardLogHandler must be called with a size parameter that specifies the size of the ring buffer. \n\n```\nSdCardLogHandler<2048> logHandler(sd, SD_CHIP_SELECT, SPI_FULL_SPEED);\n```\n\nOn Gen 3 devices, calling the SPI SD card from a log handler caused connection failures, and it never really was safe\nbefore, either. Now, a ring buffer is used to transfer the data from the log handler loop. The API change allows the\nbuffer size to be specified, but also acts as a speed bump to warn users that the log handler setup() and loop() methods\nmust be called, otherwise no data will be logged.\n\n\n### 0.0.6\n\n- Breaking change: logHandler.setup() must be called from setup(). \n\nThis fixes a problem where the log handler cannot be initialized from a global constructor in 0.8.0.rc, particularly with Gen 3 devices.\n \n\n\n\n",
  "allVersions": [
    "0.1.0",
    "0.0.6",
    "0.0.5",
    "0.0.4",
    "0.0.3",
    "0.0.2",
    "0.0.1"
  ]
}